<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Stylopia AR Video v8</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>
    <style>
      html, body { margin:0; height:100%; background: transparent; overflow:hidden; }
      a-scene { width:100%; height:100%; }
      #videoPlane { opacity: 0; transition: opacity 600ms ease-in-out; }
    </style>
  </head>
  <body>
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" renderer="antialias:true; colorManagement:true;">
      <a-assets>
        <video id="stylopiaVideo" src="assets/stylo.mp4" loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
      </a-assets>

      <!-- lighting -->
      <a-entity light="type: ambient; intensity: 1.0; color: #ffffff"></a-entity>
      <a-entity light="type: directional; intensity: 0.8; position: 1 2 2; color: #ffffff"></a-entity>

      <!-- Video plane (autoscaled) -->
      <a-plane id="videoPlane" material="shader: flat; src: #stylopiaVideo; side: double; transparent: true"
               width="0.32" height="0.18" position="0 0.3 -1.5" rotation="0 0 0"></a-plane>

      <!-- soft shadow (will scale with plane) -->
      <a-circle id="shadow" radius="0.12" position="0 0 -1.5" rotation="-90 0 0" color="#000" opacity="0.22"></a-circle>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const vid = document.getElementById('stylopiaVideo');
      const plane = document.getElementById('videoPlane');
      const shadow = document.getElementById('shadow');
      const MAX_WIDTH = 0.32; // units
      
      function setPlaneSizeFromVideo() {
        if (!vid.videoWidth || !vid.videoHeight) return false;
        const vw = vid.videoWidth, vh = vid.videoHeight;
        const aspect = vh / vw;
        const width = MAX_WIDTH;
        const height = Math.max(0.08, width * aspect); // ensure not too small
        plane.setAttribute('width', width);
        plane.setAttribute('height', height);
        // adjust shadow radius proportional to width
        shadow.setAttribute('radius', width * 0.38);
        // center plane at desired y (slightly above ground)
        plane.object3D.position.set(0, 0.3, -1.5);
        // show plane
        plane.style.opacity = 1;
        return true;
      }

      // Try to autoplay; if blocked, resume on first user gesture
      function ensurePlay() {
        vid.play().then(()=>{
          setPlaneSizeFromVideo();
        }).catch((err)=>{
          const resume = () => {
            vid.play().then(()=>{
              setPlaneSizeFromVideo();
              window.removeEventListener('touchstart', resume);
              window.removeEventListener('click', resume);
            }).catch(()=>{});
          };
          window.addEventListener('touchstart', resume, {once:true});
          window.addEventListener('click', resume, {once:true});
        });
      }

      // gentle float + slow rotation
      let t = 0;
      setInterval(()=>{
        t += 0.02;
        const y = 0.02 * Math.sin(t * 2);
        const rotY = 4 * Math.sin(t / 3);
        if (plane.object3D) {
          plane.object3D.position.y = 0.3 + y;
          plane.object3D.rotation.y = THREE.MathUtils.degToRad(rotY);
        }
      }, 16);

      // when metadata loaded, set size
      vid.addEventListener('loadedmetadata', ()=>{
        setPlaneSizeFromVideo();
      });

      window.addEventListener('load', ()=>{
        // small delay for AR init
        setTimeout(ensurePlay, 600);
      });
    </script>
  </body>
</html>
